# Active Directory path


Active Directory (AD) is a directory service for Dinwodws network environments. It is a
distributed, hierachical structure that allows for centrilizaed management of an
organization's resources, including users, computers, groups, network devices, file
shares, group policies, devices, and trusts. AD provides authentication and
authorization functions within a Window domain environment. It has come under
increasing attack in recent years. It is designed to be backward-compatible, and many
features are arguably no "secure by default", and it can be easily missconfigured. This
weakness can be leveraged to move laterally and vertically within a network and gain
unauthorized access. AD is essentially a seizeable read-only database accesible to all
users within the domain, regardless of their privilege level. A basic AD user account
with no added privileges can enumerate most objects within AD. This fact makes it
extremely important to properly secure an AD implementation because ANY user
account, reregardless ot their privilege level, can be used to enumerate the domain and
hut for misconfigurations and flaws throughtly. Also, multiple attacks can be
performed with only a standard domain usre accont showint the importance of a
defense-in-depth strategy can careful planning focussin on security and hardening AD,
network segmentation, and leas privilege. One example is the noPac attack that was
first released in December of 2021.





```
Active directory is a dreictory service for Windows networks environments. It is a 
distributes, hierachical structure that allows for centralizes management of an
organization's resources, including users, computers, groups, network devices and file
shares, group policies, servers and workstations, and trusts. AD provices
authentications and authorization functions within a  Windows domain environment. A
directory service, such as Active Directory Domain Services (AD DS) gives an
organization ways to store directory data nad make it available to both standard users
and administrators on the same network. AD DS stores information such as usernames
and passwords and manages the rights needed for authorized users to access this
information. It was first shipped with Windowns Server 2000; it has come under
increasing attack in recent years. It is designed to be backwark-compatible, and many
features are arguably not "secure by default". If is difficult to manage porperly, 
especially in large environments where it can be easily misconfigured.
```


Active directory flaws and misconfigurations can often be used to obtain a foothold
(internal acces), move laterally and vertically within a network, and gain unauthorized
access to protect resources such as databases, file shares, source code, and more. 
ADis essentially a large database accessible to all users within the domain, regardless of their privilege level. A basic AD user account with no added privileges can be used
to enumerate the majority of objects contained within AD, including but no limited to



## Actvie Directory Fundamentals


As mentioned before, there are five Flexible Single
Master Operation (FSMO) reols. These roles can be defined
as follows:



| Roles                     | Second Header |
| -----------------------   | ------------- |
| Schema Master             | This roles manages the read/write copy of the AD schema, which defines all attributes that can apply an object in AD.  |
| Domain Naming Master      | Manages domain names and ensures that two domains of the same name are not created in the same forest.  |
| Relative ID (RID) master  |  |


## Kerberos, DNS, LDAP, MSRPC

While windows operatinv systems use a variety of protocols to communicate, Active Directory
specially requires Lightweight Directory Access Protocol (LDAP), Microsoft's version Kerberos, 
DNS for authentication and communication, and MSRPC which is the Microsoft implementation
of Remote Procedure CAll (RPC), an interprocess communication technique  used for
client-server model-based applications.


### Kerberos.
Kerberos has benn the default authentication protocol for domain acounts since Windows
2000. Kerberos is an open standard and allows for interoperability with other systems
using the same standard. When a user logs into their PC, Kerberos is used to authenticate
them via mutual authentication, or both the user and the server verify their identity.
Kerberos is a stateless authentication protocol based on tickets instead of transmiting
user passwords over the network. As part of Active Directory Domain Services (AD DS),
Domain Controllers have a Kerberos Key Distribution Cender (KDC) that issued tickets.
When a user innitiates a login request to  a system, the client they are using to 
authenticate requests a ticket from the KDC, encryping the request with the user's
password. If the KDC can decrypt the request (AS-REQ) using their password, it will
create a TIcket Granting Ticket (TGT) and transmit it to the user. Then user then
presents its TGT to a Domain Controller to request a Ticket Granting SErvice (TGS)
ticket, encrypted with the associated services's NTLM  password hash. Finally, the client
requests access to the required service by presenting the TGS to the application or
service, which decrypts itwith its password hash. If the entire process completes
appropriately, the user will be permited to access the requested serice or application.



## NTLM Authentication (New Technology Lan Manager)

Adide form Kerberos and LDAP, Active Directory users several
other authentication methods which can be used (and abused) by
applications and services in AD. These include LM, NTLM, NLTMv1,
and NTLMv2 and NTLM here are the hashes names, and NTLMv1 and 
NTLMv2are authentication protocols that utilize the LM, or NT hash,
below is a quieck comparison between these hashes and protocols, which
shows us that, while not perfect by any means, Kerberos is often the 
authentication protocol of choice wherever possible. It is essential
to understand the difference between the hash types and the protocols
that use them.

| Hash/Protocol                     | Cryptographic technique |    Mutual Authentication | Message type| Trusted Third Party|
| -----------------------   | ------------- |-----------------------|-----------------------|-----------------------|
| NTLM            | Symmetric key cryptography  | No| Random Number| Domain controller|   
|NTLMv1      | Symemtric key cryptography  | No| MD4 hash, random, number| Domain Controller| 
| NTLMv2  |  Symmetric key cryptography| No | MD4 hash, random number| Domain Controller|
| Kerberos | Symmetric key cryptography & asymmetric cryptography | Yes | Encrypted ticket using DES, MD5 | Domain Controller, / key Distribution Center (KDC)|   





## LM
LAN MANAGER (LM or LANMAN) hashes are the oldest password storage
mechanism used by the Windows operating system. LM debuted in 1987 on th OS/2 operatinv system. If in use, they are stored in the 
SAM database on a Windows host and the NTDS.DIT database on a 
Domain Controller. Due to significant security weakness in
the hashing algorithm used for LM hashes, it has been turned off by
default since Windows Vista/Server 2008. However, it is still 
common to encounter, especially in large environments where older systems
are still used. Passwords using LM are limited to a maximun of 14 characters.
Passwords are not case sensitive and are converted to uppercase
before generating the hashed value, limiting the keyspace
to a total of 69 characters making it relatively easy to crack
these hashes using a tool such Hashcat.

Before Hashing, a 14 character password is first split into two
seven-character chunks, if the password is less thatn fourteen 
characters, it willbe apdded with NULL charcaters to reach the 
correct value. Two DES keys are created from each chunk. These
chunks are then encrypted using the string **KGS!@#$%**, creating 
two 8-byte ciphertext values. These two values are then concatenaded
together, resulting in a LMhash. This hashing algorithm means
that an attacker only needs to brute froce






















