# from mysmb import MYSMB
from impacket.smbconnection import SMBConnection
from impacket import smb, smbconnection, nt_errors
from impacket.uuid import uuidtup_to_bin
from impacket.dcerpc.v5.rpcrt import DCERPCException
from struct import pack
import sys
import argparse


'''
Script for
- check target if MS17-010 is patched or not.
- find accessible named pipe
'''



class MySMBConnection:
    def __init__(self, target_ip, port=445):
        self.conn = SMBConnection(remoteName=target_ip, remoteHost=target_ip, sess_port=port)
        self.default_tid = None

    def login(self, username, password):
        self.conn.login(username, password)

    def list_shares(self):
        return self.conn.listShares()

    def get_server_os(self):
        return self.conn.getServerOS()

    def tree_connect_andx(self, share_name):
        tid = self.conn.connectTree(share_name)
        return tid

    def set_default_tid(self, tid):
        self.default_tid = tid

    def send_trans(self, tid, data):
        try:
            response = self.conn.transactNamedPipe(tid, data)
            return response
        except Exception as e:
            print(f"Error during transaction: {e}")
            return None

    def disconnect_tree(self, tid):
        self.conn.disconnectTree(tid)

    def logoff(self):
        self.conn.logoff()

    def close(self):
        self.conn.close()





def check_ms17_010(conn):
    TRANS_PEEK_NMPIPE = b"\x23"  # Correctly define the data to be sent
    try:
        recvPkt = conn.send_trans(conn.default_tid, TRANS_PEEK_NMPIPE)
        if recvPkt is None:
            print("[-] Failed to send transaction.")
            sys.exit()

        # If recvPkt provides NTStatus
        status = recvPkt.getNTStatus() if hasattr(recvPkt, "getNTStatus") else None

        if status == 0xC0000205:  # STATUS_INSUFF_SERVER_RESOURCES
            print('[!] The target is not patched')
        else:
            print('[-] The target is patched')
            sys.exit()
    except Exception as e:
        print(f"Error checking MS17-010: {e}")
        sys.exit()

def check_accessible_pipes(conn):
    print('=== Testing named pipes ===')
    conn.find_named_pipe(firstOnly=False)

def main():
    parser = argparse.ArgumentParser()
    
    parser.add_argument('target', action='store',
    help='[[domain/]username[:password]@]<targetName or address>')

    group = parser.add_argument_group('connection')
    group.add_argument('-target-ip', action='store', metavar="ip address", 
    help='IP Address of the target machine. If ommited it will use whatever was specified as target. This is useful when target is the NetBIOS name and you cannot resolve it')
    group.add_argument('-port', choices=['139', '445'], nargs='?', default='445', metavar="destination port",
    help='Destination port to connect to SMB Server')

    if len(sys.argv)==1:
        parser.print_help()
        sys.exit(1)
    options = parser.parse_args()

    import re
    domain, username, password, remoteName = re.compile('(?:(?:([^/@:]*)/)?([^@:]*)(?::([^@]*))?@)?(.*)').match(options.target).groups('')

    #In case the password contains '@'
    if '@' in remoteName:
        password = password + '@' + remoteName.rpartition('@')[0]
        remoteName = remoteName.rpartition('@')[2]

    if domain is None:
        domain = ''

    if password == '' and username != '' and options.hashes is None and options.no_pass is False and options.aesKey is None:
        from getpass import getpass
        password = getpass("Password:")

    if options.target_ip is None:
        options.target_ip = remoteName

    conn = MySMBConnection(options.target_ip, int(options.port))
    os_info = conn.get_server_os()
    try:
        conn.login(username, password)
    except smb.SessionError as e:
        print('[-] Login failed: ' + nt_errors.ERROR_MESSAGES[e.error_code][0])
        sys.exit()
    finally:
        print('[*] Target OS: ' + conn.get_server_os())

    tid = conn.tree_connect_andx(f'\\\\{options.target_ip}\\IPC$')
    conn.set_default_tid(tid)  # Set the default tree ID
    
    print(f"Default TID: {conn.default_tid}")
    print(f"Data Sent: {TRANS_PEEK_NMPIPE}")

    check_ms17_010(conn)
    check_accessible_pipes(conn)

    conn.disconnect_tree(tid)
    conn.logoff()
    conn.get_socket().close()

    print('[*] Done')



main()
