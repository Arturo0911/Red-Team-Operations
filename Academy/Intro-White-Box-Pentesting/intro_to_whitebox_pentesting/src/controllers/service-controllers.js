const QRCode = require("qrcode");

function validateString(input, onError) {
  if (
    typeof input !== "string" ||
    input.length == 0 ||
    input.match(/['"`;]/g)
  ) {
    eval(onError);
    return false;
  }
  return true;
}

async function generateQR(req, res, next) {
  const { text } = req.body;
  const role = req.user.role;

  try {
    !validateString(
      text,
      // provide verbose error message 'for admins only'
      role === "admin"
        ? `throw({message: 'The input "${text}" contains the following invalid characters: [${text.match(
            /['"`;]/g
          )}]', statusCode: 403})`
        : "throw({message: 'Invalid input', statusCode: 403})"
    );

    QRCode.toDataURL(
      text,
      {
        width: 500,
        height: 500,
      },
      (err, src) => {
        if (err) {
          throw err;
        }

        res.send(`<img src="${src}" alt="QR Code" />`);
      }
    );
  } catch (e) {
    if (e.statusCode === 403) {
      return next(e);
    } else {
      return next({
        message: "Could not generate QR code.",
        statusCode: 500,
      });
    }
  }
}

module.exports = {
  generateQR,
};
